<script>
  // 1) Carte
  const map = L.map('map').setView([0, 0], 2);
  L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
    maxZoom: 19, attribution: '&copy; OpenStreetMap contributors'
  }).addTo(map);

  let marker = null, accuracyCircle = null;
  const info = document.getElementById('info');

  function onLocationFound(e) {
    const { latlng, accuracy } = e;
    if (marker) map.removeLayer(marker);
    if (accuracyCircle) map.removeLayer(accuracyCircle);

    marker = L.marker(latlng).addTo(map).bindPopup('Vous êtes ici');
    accuracyCircle = L.circle(latlng, { radius: accuracy }).addTo(map);
    map.setView(latlng, 16);
    info.textContent =
      `Lat: ${latlng.lat.toFixed(6)} | Lng: ${latlng.lng.toFixed(6)} | Précision ≈ ${Math.round(accuracy)} m`;
    marker.openPopup();
  }

  function onLocationError(e) {
    const msg = (e.message || '').toString();
    info.textContent = "Erreur de géolocalisation : " + msg;
    alert(
      "Géolocalisation impossible : " + msg +
      "\nVérifie : Réglages > Confidentialité > Service de localisation (activé)," +
      "\nSafari > Localisation : Autoriser (Position exacte activée)."
    );
  }

  map.on('locationfound', onLocationFound);
  map.on('locationerror', onLocationError);

  // Demande de position (appelée au clic et au chargement)
  function requestLocation(isAuto = false) {
    if (!('geolocation' in navigator)) {
      info.textContent = "Ce navigateur ne supporte pas la géolocalisation.";
      return;
    }
    info.textContent = isAuto
      ? "Demande d’autorisation envoyée…"
      : "Recherche de votre position…";
    map.locate({
      setView: false,
      enableHighAccuracy: true,
      timeout: 15000,
      maximumAge: 0
    });
    // Petit rappel si ça traîne
    setTimeout(() => {
      if (info.textContent.includes("Demande") || info.textContent.includes("Recherche")) {
        info.textContent = "Toujours en attente… Autorise la localisation pour ce site.";
      }
    }, 6000);
  }

  document.getElementById('locateBtn').addEventListener('click', () => requestLocation(false));

  // Demande automatique dès l’ouverture de la page
  window.addEventListener('load', () => requestLocation(true));
</script>
